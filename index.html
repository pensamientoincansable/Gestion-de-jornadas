<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telepizza - Gesti√≥n de Jornadas</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }
        
        body {
            background-color: #D4001C;
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            text-align: center;
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.4);
            background: linear-gradient(to right, #FFFFFF, #FFC72C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 35px;
        }
        
        .logo span {
            font-size: 1.8rem;
            font-weight: 800;
            background-color: white;
            color: #D4001C;
            padding: 8px 20px;
            border-radius: 15px;
            display: inline-block;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .selector, .telepizzero-section, .gerencia-section, .registro-section, .gestion-usuarios-section {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 25px;
        }
        
        .active {
            display: flex;
        }
        
        .btn {
            background: linear-gradient(145deg, #FFFFFF, #F5F5F5);
            color: #D4001C;
            border: none;
            padding: 16px 45px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .btn-secondary {
            background: linear-gradient(145deg, #FFC72C, #FFB300);
            color: #D4001C;
        }
        
        .btn-danger {
            background: linear-gradient(145deg, #FF5252, #D32F2F);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(145deg, #4CAF50, #388E3C);
            color: white;
        }
        
        .btn-reporte {
            background: linear-gradient(145deg, #E0D3B8, #C5B79A);
            color: #333;
        }
        
        .btn-reporte:hover {
            background: linear-gradient(145deg, #C5B79A, #A8997A);
        }
        
        .btn-gris {
            background: linear-gradient(145deg, #9E9E9E, #757575);
            color: white;
        }
        
        .btn-gris:hover {
            background: linear-gradient(145deg, #757575, #616161);
        }
        
        input, select {
            padding: 16px;
            width: 100%;
            max-width: 320px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            text-align: center;
            color: #D4001C;
            background-color: rgba(255, 255, 255, 0.95);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: 3px solid #FFC72C;
            box-shadow: 0 0 15px rgba(255, 199, 44, 0.5);
        }
        
        .mensaje {
            margin-top: 20px;
            padding: 18px;
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            text-align: center;
            font-size: 1.1rem;
            min-height: 65px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            border-left: 5px solid #FFC72C;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        th {
            background-color: rgba(0, 0, 0, 0.35);
            font-weight: 800;
            text-transform: uppercase;
            color: #FFC72C;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .volver-btn {
            margin-top: 25px;
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .volver-btn:hover {
            background-color: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .tab-btn {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            padding: 14px 28px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
            border: 2px solid transparent;
        }
        
        .tab-btn:hover {
            background-color: rgba(255, 255, 255, 0.25);
        }
        
        .tab-btn.active {
            background-color: white;
            color: #D4001C;
            border-color: #FFC72C;
            box-shadow: 0 4px 12px rgba(255, 199, 44, 0.3);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
            width: 100%;
            max-width: 420px;
        }
        
        .form-group label {
            font-weight: 700;
            text-align: center;
            color: #FFC72C;
            font-size: 1.1rem;
        }
        
        .usuario-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            background-color: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            margin-bottom: 12px;
            width: 100%;
            max-width: 520px;
            border-left: 4px solid #FFC72C;
            transition: all 0.3s ease;
        }
        
        .usuario-item:hover {
            background-color: rgba(255, 255, 255, 0.12);
            transform: translateX(5px);
        }
        
        .ausencia-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            background-color: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            margin-bottom: 12px;
            width: 100%;
            border-left: 4px solid #FF5252;
        }
        
        .ausencia-marcada {
            background-color: rgba(255, 82, 82, 0.25);
        }
        
        .botones-accion {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 10px 18px;
            font-size: 0.9rem;
            border-radius: 8px;
        }
        
        .btn-icon {
            padding: 10px;
            font-size: 1rem;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .geolocalizacion-info {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(255, 199, 44, 0.1));
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            width: 100%;
            text-align: center;
            border: 2px solid rgba(255, 199, 44, 0.3);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .geolocalizacion-info h3 {
            margin-bottom: 12px;
            color: #FFC72C;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .mapa {
            width: 100%;
            height: 220px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .mapa iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .coordenadas {
            font-family: 'Courier New', monospace;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 8px;
            margin-top: 8px;
            display: inline-block;
            color: #FFC72C;
        }
        
        .ubicacion-aproximada {
            font-size: 0.95rem;
            color: #FFC72C;
            margin-top: 8px;
            font-style: italic;
        }
        
        .permiso-geolocalizacion {
            background: linear-gradient(145deg, rgba(255, 199, 44, 0.25), rgba(255, 179, 0, 0.2));
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            text-align: center;
            border: 3px solid #FFC72C;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 8px 25px rgba(255, 199, 44, 0.3);
        }
        
        .permiso-geolocalizacion h3 {
            margin-bottom: 15px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        .permiso-geolocalizacion p {
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .loader {
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid #FFC72C;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            animation: spin 1.2s linear infinite;
            margin: 15px auto;
        }
        
        .correo-info {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), rgba(76, 175, 80, 0.1));
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            width: 100%;
            border: 2px solid rgba(76, 175, 80, 0.3);
        }
        
        .correo-info h3 {
            margin-bottom: 12px;
            color: #4CAF50;
        }
        
        .sincronizacion-info {
            background: linear-gradient(145deg, rgba(33, 150, 243, 0.1), rgba(30, 136, 229, 0.1));
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
            border-left: 4px solid #2196F3;
        }
        
        .sincronizacion-info p {
            color: #BBDEFB;
            font-size: 0.95rem;
        }
        
        .badge {
            background-color: #FFC72C;
            color: #D4001C;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-left: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulsating {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 199, 44, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 199, 44, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 199, 44, 0); }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                border-radius: 15px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .btn {
                padding: 14px 35px;
                font-size: 1.1rem;
            }
            
            input, select {
                max-width: 100%;
            }
            
            th, td {
                padding: 12px;
                font-size: 0.95rem;
            }
            
            .usuario-item, .ausencia-item {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
            
            .botones-accion {
                width: 100%;
                justify-content: center;
            }
            
            .tabs {
                gap: 8px;
            }
            
            .tab-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.8rem;
            }
            
            .logo span {
                font-size: 1.4rem;
                padding: 6px 15px;
            }
            
            .btn {
                padding: 12px 30px;
                font-size: 1rem;
                width: 100%;
                max-width: 300px;
            }
            
            .tab-btn {
                padding: 10px 16px;
                font-size: 0.8rem;
            }
            
            .permiso-geolocalizacion {
                padding: 20px 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container fade-in">
        <div class="logo">
            <h1>Telepizza</h1>
            <span>Gesti√≥n de Jornadas</span>
        </div>
        
        <!-- Selecci√≥n de rol -->
        <div class="selector active">
            <h2>Selecciona tu rol</h2>
            <button class="btn pulsating" id="btnTelepizzero">Telepizzero</button>
            <button class="btn" id="btnGerencia">Gerencia</button>
            
            <div class="sincronizacion-info">
                <p>‚úÖ Sistema sincronizado en la nube - Accede desde cualquier dispositivo</p>
            </div>
        </div>
        
        <!-- Secci√≥n para telepizzeros -->
        <div class="telepizzero-section">
            <h2>Registro de Jornada</h2>
            
            <div class="permiso-geolocalizacion" id="permisoGeolocalizacion">
                <h3>üìç Activaci√≥n de Geolocalizaci√≥n Requerida</h3>
                <p>Para registrar tu jornada de forma segura, necesitamos acceder a tu ubicaci√≥n precisa.</p>
                <p>Por favor, <strong>permite el acceso a la ubicaci√≥n</strong> cuando tu navegador lo solicite.</p>
                <p>Si no ves la solicitud, verifica los permisos de tu navegador.</p>
                <div class="loader" id="loaderGeolocalizacion"></div>
                <button class="btn btn-success pulsating" id="btnActivarGeolocalizacion">Activar Geolocalizaci√≥n</button>
            </div>
            
            <div id="contenidoFichaje" style="display: none;">
                <div class="form-group">
                    <label for="dniInput">Introduce tu DNI (8 d√≠gitos)</label>
                    <input type="text" id="dniInput" placeholder="Ej: 20086762" maxlength="8" pattern="\d*" inputmode="numeric">
                    <small style="color: #FFC72C; font-size: 0.9rem;">Solo 8 n√∫meros, sin letras ni espacios</small>
                </div>
                
                <button class="btn" id="btnFichar">Fichar Entrada/Salida</button>
                
                <div class="geolocalizacion-info" id="infoGeolocalizacion">
                    <h3>üìç Ubicaci√≥n Detectada</h3>
                    <div id="estadoGeolocalizacion">Obteniendo ubicaci√≥n...</div>
                    <div class="coordenadas" id="coordenadas"></div>
                    <div class="ubicacion-aproximada" id="direccionAproximada"></div>
                    <div class="mapa" id="mapaContainer">
                        <div id="mapaPlaceholder">Mapa de ubicaci√≥n se cargar√° aqu√≠</div>
                    </div>
                </div>
                
                <div class="mensaje" id="mensajeTelepizzero"></div>
            </div>
            
            <button class="btn volver-btn" id="volverTelepizzero">Volver al Men√∫</button>
        </div>
        
        <!-- Secci√≥n para gerencia -->
        <div class="gerencia-section">
            <h2>Acceso Gerencia</h2>
            <div class="form-group">
                <label for="passwordInput">Contrase√±a de Gerencia</label>
                <input type="password" id="passwordInput" placeholder="Introduce la contrase√±a">
            </div>
            <button class="btn" id="btnAcceder">Acceder</button>
            <div class="mensaje" id="mensajeGerencia"></div>
            <button class="btn volver-btn" id="volverGerencia">Volver</button>
        </div>
        
        <!-- Secci√≥n de gesti√≥n para gerencia -->
        <div class="registro-section">
            <h2>Panel de Gerencia <span class="badge">Sincronizado</span></h2>
            
            <div class="tabs">
                <div class="tab-btn active" data-tab="registros">üìä Registros</div>
                <div class="tab-btn" data-tab="usuarios">üë• Gesti√≥n de Usuarios</div>
                <div class="tab-btn" data-tab="ausencias">‚ö†Ô∏è Control de Ausencias</div>
                <div class="tab-btn" data-tab="correo">üìß Configuraci√≥n de Correo</div>
            </div>
            
            <!-- Pesta√±a de Registros -->
            <div class="tab-content active" id="registros-tab">
                <h3>Registro de Jornadas</h3>
                
                <div class="sincronizacion-info">
                    <p>‚úÖ Datos sincronizados desde la nema - Total registros: <span id="totalRegistros">0</span></p>
                </div>
                
                <table id="tablaRegistros">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>DNI</th>
                            <th>Fecha</th>
                            <th>Entrada</th>
                            <th>Salida</th>
                            <th>Horas</th>
                            <th>Ubicaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Los registros se llenar√°n con JavaScript -->
                    </tbody>
                </table>
                
                <div style="margin-top: 25px; text-align: center; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-reporte" id="btnEnviarReporteDiario">üì§ Enviar Reporte Diario</button>
                    <button class="btn btn-gris" id="btnEnviarReporteMensual">üìà Enviar Reporte Mensual</button>
                </div>
            </div>
            
            <!-- Pesta√±a de Gesti√≥n de Usuarios -->
            <div class="tab-content" id="usuarios-tab">
                <h3>Gesti√≥n de Telepizzeros</h3>
                
                <div class="form-group">
                    <label for="nuevoDni">DNI del nuevo Telepizzero (8 d√≠gitos)</label>
                    <input type="text" id="nuevoDni" placeholder="Ej: 20086762" maxlength="8" pattern="\d*" inputmode="numeric">
                    
                    <label for="nuevoNombre">Nombre completo</label>
                    <input type="text" id="nuevoNombre" placeholder="Ej: Juan P√©rez">
                    
                    <button class="btn btn-secondary" id="btnAgregarUsuario">‚ûï Agregar Telepizzero</button>
                </div>
                
                <div id="listaUsuarios">
                    <!-- Lista de usuarios se llenar√° con JavaScript -->
                </div>
            </div>
            
            <!-- Pesta√±a de Control de Ausencias -->
            <div class="tab-content" id="ausencias-tab">
                <h3>Control de Ausencias y Faltas</h3>
                
                <div class="form-group">
                    <label for="selectUsuarioAusencia">Seleccionar Telepizzero</label>
                    <select id="selectUsuarioAusencia">
                        <!-- Opciones se llenar√°n con JavaScript -->
                    </select>
                    
                    <label for="fechaAusencia">Fecha de la ausencia</label>
                    <input type="date" id="fechaAusencia">
                    
                    <label for="tipoAusencia">Tipo de incidencia</label>
                    <select id="tipoAusencia">
                        <option value="falta">‚ùå Falta injustificada</option>
                        <option value="ausencia_justificada">‚ö†Ô∏è Ausencia justificada</option>
                        <option value="retraso">‚è∞ Retraso</option>
                    </select>
                    
                    <label for="motivoAusencia">Motivo (opcional)</label>
                    <input type="text" id="motivoAusencia" placeholder="Motivo de la ausencia">
                    
                    <button class="btn btn-secondary" id="btnRegistrarAusencia">üìù Registrar Incidencia</button>
                </div>
                
                <h4>üìã Incidencias Registradas</h4>
                <div id="listaAusencias">
                    <!-- Lista de ausencias se llenar√° con JavaScript -->
                </div>
            </div>
            
            <!-- Pesta√±a de Configuraci√≥n de Correo -->
            <div class="tab-content" id="correo-tab">
                <h3>Vincular Correo Electr√≥nico</h3>
                
                <div class="correo-info">
                    <h3>‚öôÔ∏è Configuraci√≥n de Reportes Autom√°ticos</h3>
                    <p>Vincule una cuenta de correo para recibir reportes autom√°ticos de jornadas laborales.</p>
                </div>
                
                <div class="form-group">
                    <label for="correoElectronico">Correo Electr√≥nico</label>
                    <input type="email" id="correoElectronico" placeholder="gerencia@telepizza.com">
                    
                    <button class="btn btn-success" id="btnGuardarCorreo">üíæ Guardar Correo</button>
                </div>
                
                <div class="correo-info" id="infoCorreoGuardado">
                    <!-- Informaci√≥n del correo guardado se mostrar√° aqu√≠ -->
                </div>
                
                <div class="form-group">
                    <h4>üì§ Enviar Reportes Manualmente</h4>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-reporte" id="btnEnviarDiarioManual">üìä Reporte Diario</button>
                        <button class="btn btn-gris" id="btnEnviarMensualManual">üìà Reporte Mensual</button>
                    </div>
                </div>
                
                <div class="mensaje" id="mensajeCorreo"></div>
            </div>
            
            <button class="btn volver-btn" id="volverRegistro">‚Üê Volver al Men√∫</button>
        </div>
    </div>

    <script>
        // ============================================
        // SISTEMA DE ALMACENAMIENTO EN LA NUBE (SIMULACI√ìN)
        // ============================================
        
        // Clave √∫nica para simular almacenamiento en la nube
        const CLOUD_STORAGE_KEY = 'telepizza_cloud_data';
        
        // Funci√≥n para cargar datos desde la "nube"
        function cargarDesdeLaNube() {
            try {
                const cloudData = JSON.parse(localStorage.getItem(CLOUD_STORAGE_KEY)) || {};
                
                // Inicializar datos si no existen
                if (!cloudData.telepizzeros) {
                    cloudData.telepizzeros = [{ dni: "20086762", nombre: "Noel" }];
                }
                
                if (!cloudData.registros) cloudData.registros = [];
                if (!cloudData.ausencias) cloudData.ausencias = [];
                if (!cloudData.correo) cloudData.correo = null;
                
                return cloudData;
            } catch (error) {
                console.error("Error cargando datos de la nube:", error);
                return {
                    telepizzeros: [{ dni: "20086762", nombre: "Noel" }],
                    registros: [],
                    ausencias: [],
                    correo: null
                };
            }
        }
        
        // Funci√≥n para guardar datos en la "nube"
        function guardarEnLaNube(data) {
            try {
                localStorage.setItem(CLOUD_STORAGE_KEY, JSON.stringify(data));
                console.log("Datos guardados en la nube:", data);
                return true;
            } catch (error) {
                console.error("Error guardando datos en la nube:", error);
                return false;
            }
        }
        
        // Funci√≥n para sincronizar datos locales con la nube
        function sincronizarConLaNube() {
            const cloudData = cargarDesdeLaNube();
            
            // Actualizar variables locales
            telepizzeros = cloudData.telepizzeros;
            registros = cloudData.registros;
            ausencias = cloudData.ausencias;
            correoGerencia = cloudData.correo;
            
            // Actualizar contador de registros
            document.getElementById('totalRegistros').textContent = registros.length;
            
            return cloudData;
        }
        
        // Funci√≥n para guardar cambios y sincronizar
        function guardarYSincronizar() {
            const cloudData = {
                telepizzeros,
                registros,
                ausencias,
                correo: correoGerencia
            };
            
            if (guardarEnLaNube(cloudData)) {
                console.log("‚úÖ Datos sincronizados correctamente");
                return true;
            } else {
                console.error("‚ùå Error sincronizando datos");
                return false;
            }
        }
        
        // ============================================
        // VARIABLES GLOBALES Y DATOS INICIALES
        // ============================================
        
        // Cargar datos iniciales desde la nube
        let { telepizzeros, registros, ausencias, correo: correoGerencia } = sincronizarConLaNube();
        
        // Variables para geolocalizaci√≥n
        let ubicacionActual = null;
        let watchId = null;
        let geolocalizacionActivada = false;
        
        // ============================================
        // ELEMENTOS DEL DOM
        // ============================================
        
        const selector = document.querySelector('.selector');
        const telepizzeroSection = document.querySelector('.telepizzero-section');
        const gerenciaSection = document.querySelector('.gerencia-section');
        const registroSection = document.querySelector('.registro-section');
        
        const btnTelepizzero = document.getElementById('btnTelepizzero');
        const btnGerencia = document.getElementById('btnGerencia');
        const btnFichar = document.getElementById('btnFichar');
        const btnAcceder = document.getElementById('btnAcceder');
        const volverTelepizzero = document.getElementById('volverTelepizzero');
        const volverGerencia = document.getElementById('volverGerencia');
        const volverRegistro = document.getElementById('volverRegistro');
        
        const dniInput = document.getElementById('dniInput');
        const passwordInput = document.getElementById('passwordInput');
        const mensajeTelepizzero = document.getElementById('mensajeTelepizzero');
        const mensajeGerencia = document.getElementById('mensajeGerencia');
        const tablaRegistros = document.querySelector('#tablaRegistros tbody');
        const totalRegistrosElement = document.getElementById('totalRegistros');
        
        // Elementos de geolocalizaci√≥n
        const permisoGeolocalizacion = document.getElementById('permisoGeolocalizacion');
        const contenidoFichaje = document.getElementById('contenidoFichaje');
        const btnActivarGeolocalizacion = document.getElementById('btnActivarGeolocalizacion');
        const loaderGeolocalizacion = document.getElementById('loaderGeolocalizacion');
        const estadoGeolocalizacion = document.getElementById('estadoGeolocalizacion');
        const coordenadasElement = document.getElementById('coordenadas');
        const direccionAproximada = document.getElementById('direccionAproximada');
        const mapaContainer = document.getElementById('mapaContainer');
        
        // Elementos de gesti√≥n de usuarios
        const btnAgregarUsuario = document.getElementById('btnAgregarUsuario');
        const nuevoDni = document.getElementById('nuevoDni');
        const nuevoNombre = document.getElementById('nuevoNombre');
        const listaUsuarios = document.getElementById('listaUsuarios');
        
        // Elementos de control de ausencias
        const selectUsuarioAusencia = document.getElementById('selectUsuarioAusencia');
        const fechaAusencia = document.getElementById('fechaAusencia');
        const tipoAusencia = document.getElementById('tipoAusencia');
        const motivoAusencia = document.getElementById('motivoAusencia');
        const btnRegistrarAusencia = document.getElementById('btnRegistrarAusencia');
        const listaAusencias = document.getElementById('listaAusencias');
        
        // Elementos de configuraci√≥n de correo
        const correoElectronico = document.getElementById('correoElectronico');
        const btnGuardarCorreo = document.getElementById('btnGuardarCorreo');
        const infoCorreoGuardado = document.getElementById('infoCorreoGuardado');
        const mensajeCorreo = document.getElementById('mensajeCorreo');
        const btnEnviarDiarioManual = document.getElementById('btnEnviarDiarioManual');
        const btnEnviarMensualManual = document.getElementById('btnEnviarMensualManual');
        const btnEnviarReporteDiario = document.getElementById('btnEnviarReporteDiario');
        const btnEnviarReporteMensual = document.getElementById('btnEnviarReporteMensual');
        
        // Tabs
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // ============================================
        // CONFIGURACI√ìN INICIAL
        // ============================================
        
        // Establecer fecha actual por defecto
        const hoy = new Date();
        fechaAusencia.value = hoy.toISOString().split('T')[0];
        
        // Actualizar contador de registros
        totalRegistrosElement.textContent = registros.length;
        
        // ============================================
        // INICIALIZACI√ìN DE LA APLICACI√ìN
        // ============================================
        
        function init() {
            cargarUsuarios();
            cargarAusencias();
            cargarCorreoGuardado();
            
            // Si hay usuarios, cargar el select de ausencias
            if (telepizzeros.length > 0) {
                cargarSelectUsuarios();
            }
            
            // Mostrar mensaje de bienvenida
            console.log("‚úÖ Sistema de Telepizza cargado correctamente");
            console.log(`üìä Total de registros en la nube: ${registros.length}`);
            console.log(`üë• Total de telepizzeros: ${telepizzeros.length}`);
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        btnTelepizzero.addEventListener('click', () => {
            selector.classList.remove('active');
            telepizzeroSection.classList.add('active');
            
            // Forzar que se muestre siempre el permiso de geolocalizaci√≥n
            permisoGeolocalizacion.style.display = 'block';
            contenidoFichaje.style.display = 'none';
            geolocalizacionActivada = false;
            
            // Mostrar mensaje espec√≠fico para PC
            if (window.innerWidth > 768) {
                const pcMessage = document.createElement('p');
                pcMessage.style.color = '#FFC72C';
                pcMessage.style.marginTop = '10px';
                pcMessage.style.fontWeight = 'bold';
                pcMessage.textContent = 'üíª En PC, haz clic en "Activar Geolocalizaci√≥n" y permite los permisos en tu navegador.';
                
                if (!document.getElementById('pcMessage')) {
                    pcMessage.id = 'pcMessage';
                    permisoGeolocalizacion.appendChild(pcMessage);
                }
            }
        });
        
        btnGerencia.addEventListener('click', () => {
            selector.classList.remove('active');
            gerenciaSection.classList.add('active');
            passwordInput.focus();
        });
        
        btnFichar.addEventListener('click', fichar);
        
        btnAcceder.addEventListener('click', () => {
            if (passwordInput.value === "369") {
                gerenciaSection.classList.remove('active');
                registroSection.classList.add('active');
                cargarRegistros();
            } else {
                mensajeGerencia.textContent = "‚ùå Contrase√±a incorrecta. Int√©ntalo de nuevo.";
                passwordInput.value = "";
                passwordInput.focus();
            }
        });
        
        volverTelepizzero.addEventListener('click', () => {
            detenerGeolocalizacion();
            telepizzeroSection.classList.remove('active');
            selector.classList.add('active');
            dniInput.value = "";
            mensajeTelepizzero.textContent = "";
            permisoGeolocalizacion.style.display = 'block';
            contenidoFichaje.style.display = 'none';
            geolocalizacionActivada = false;
        });
        
        volverGerencia.addEventListener('click', () => {
            gerenciaSection.classList.remove('active');
            selector.classList.add('active');
            passwordInput.value = "";
            mensajeGerencia.textContent = "";
        });
        
        volverRegistro.addEventListener('click', () => {
            registroSection.classList.remove('active');
            selector.classList.add('active');
        });
        
        // Gesti√≥n de usuarios
        btnAgregarUsuario.addEventListener('click', agregarUsuario);
        
        // Control de ausencias
        btnRegistrarAusencia.addEventListener('click', registrarAusencia);
        
        // Configuraci√≥n de correo
        btnGuardarCorreo.addEventListener('click', guardarCorreo);
        btnEnviarDiarioManual.addEventListener('click', () => enviarReporte('diario'));
        btnEnviarMensualManual.addEventListener('click', () => enviarReporte('mensual'));
        btnEnviarReporteDiario.addEventListener('click', () => enviarReporte('diario'));
        btnEnviarReporteMensual.addEventListener('click', () => enviarReporte('mensual'));
        
        // Tabs
        tabBtns.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                
                // Actualizar botones de pesta√±a
                tabBtns.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Actualizar contenido de pesta√±as
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
        
        // Geolocalizaci√≥n
        btnActivarGeolocalizacion.addEventListener('click', iniciarGeolocalizacion);
        
        // Validaci√≥n de DNI en tiempo real
        dniInput.addEventListener('input', function() {
            // Solo permitir n√∫meros
            this.value = this.value.replace(/\D/g, '');
            
            // Limitar a 8 d√≠gitos
            if (this.value.length > 8) {
                this.value = this.value.slice(0, 8);
            }
        });
        
        nuevoDni.addEventListener('input', function() {
            // Solo permitir n√∫meros
            this.value = this.value.replace(/\D/g, '');
            
            // Limitar a 8 d√≠gitos
            if (this.value.length > 8) {
                this.value = this.value.slice(0, 8);
            }
        });
        
        // ============================================
        // FUNCIONES DE GEOLOCALIZACI√ìN
        // ============================================
        
        // Funci√≥n para iniciar la geolocalizaci√≥n
        function iniciarGeolocalizacion() {
            estadoGeolocalizacion.textContent = "‚è≥ Obteniendo ubicaci√≥n...";
            loaderGeolocalizacion.style.display = 'block';
            btnActivarGeolocalizacion.disabled = true;
            btnActivarGeolocalizacion.textContent = "Activando...";
            
            if (!navigator.geolocation) {
                estadoGeolocalizacion.textContent = "‚ùå La geolocalizaci√≥n no es compatible con este navegador";
                loaderGeolocalizacion.style.display = 'none';
                btnActivarGeolocalizacion.disabled = false;
                btnActivarGeolocalizacion.textContent = "Activar Geolocalizaci√≥n";
                return;
            }
            
            // Opciones para una mayor precisi√≥n
            const opciones = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            };
            
            // Solicitar permiso de geolocalizaci√≥n
            navigator.geolocation.getCurrentPosition(
                // √âxito
                function(posicion) {
                    loaderGeolocalizacion.style.display = 'none';
                    btnActivarGeolocalizacion.disabled = false;
                    btnActivarGeolocalizacion.textContent = "Geolocalizaci√≥n Activada";
                    
                    ubicacionActual = {
                        latitud: posicion.coords.latitude,
                        longitud: posicion.coords.longitude,
                        precision: posicion.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };
                    
                    // Mostrar informaci√≥n de ubicaci√≥n
                    mostrarInformacionUbicacion();
                    geolocalizacionActivada = true;
                    
                    // Iniciar seguimiento continuo de la ubicaci√≥n
                    watchId = navigator.geolocation.watchPosition(
                        function(pos) {
                            ubicacionActual = {
                                latitud: pos.coords.latitude,
                                longitud: pos.coords.longitude,
                                precision: pos.coords.accuracy,
                                timestamp: new Date().toISOString()
                            };
                            mostrarInformacionUbicacion();
                        },
                        function(error) {
                            console.error("Error en el seguimiento de ubicaci√≥n:", error);
                        },
                        opciones
                    );
                    
                    // Mostrar contenido de fichaje
                    permisoGeolocalizacion.style.display = 'none';
                    contenidoFichaje.style.display = 'flex';
                    dniInput.focus();
                },
                // Error
                function(error) {
                    loaderGeolocalizacion.style.display = 'none';
                    btnActivarGeolocalizacion.disabled = false;
                    btnActivarGeolocalizacion.textContent = "Activar Geolocalizaci√≥n";
                    
                    let mensajeError = "‚ùå Error al obtener la ubicaci√≥n: ";
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            mensajeError = "üîí Permiso de ubicaci√≥n denegado. Para continuar:";
                            mensajeError += "\n1. Haz clic en el icono de candado en la barra de direcciones";
                            mensajeError += "\n2. Selecciona 'Permitir' en la secci√≥n de Ubicaci√≥n";
                            mensajeError += "\n3. Recarga la p√°gina o haz clic nuevamente en 'Activar Geolocalizaci√≥n'";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            mensajeError += "La informaci√≥n de ubicaci√≥n no est√° disponible.";
                            break;
                        case error.TIMEOUT:
                            mensajeError += "Tiempo de espera agotado al obtener la ubicaci√≥n.";
                            break;
                        default:
                            mensajeError += "Error desconocido.";
                            break;
                    }
                    
                    estadoGeolocalizacion.textContent = mensajeError;
                    
                    // Mantener visible el permiso para intentar nuevamente
                    permisoGeolocalizacion.style.display = 'block';
                    contenidoFichaje.style.display = 'none';
                },
                opciones
            );
        }
        
        // Funci√≥n para detener la geolocalizaci√≥n
        function detenerGeolocalizacion() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            ubicacionActual = null;
            geolocalizacionActivada = false;
        }
        
        // Funci√≥n para mostrar informaci√≥n de la ubicaci√≥n
        function mostrarInformacionUbicacion() {
            if (!ubicacionActual) return;
            
            coordenadasElement.textContent = `Lat: ${ubicacionActual.latitud.toFixed(6)}, Lng: ${ubicacionActual.longitud.toFixed(6)}`;
            estadoGeolocalizacion.textContent = "‚úÖ Ubicaci√≥n obtenida correctamente";
            direccionAproximada.textContent = `Precisi√≥n: ¬±${Math.round(ubicacionActual.precision)} metros`;
            
            // Mostrar mapa
            mostrarMapa();
        }
        
        // Funci√≥n para mostrar el mapa
        function mostrarMapa() {
            if (!ubicacionActual) return;
            
            const { latitud, longitud } = ubicacionActual;
            const urlMapa = `https://maps.google.com/maps?q=${latitud},${longitud}&z=17&output=embed`;
            
            mapaContainer.innerHTML = `<iframe src="${urlMapa}" allowfullscreen title="Ubicaci√≥n actual"></iframe>`;
        }
        
        // ============================================
        // FUNCI√ìN PRINCIPAL DE FICHAJE
        // ============================================
        
        function fichar() {
            // Verificar que tenemos ubicaci√≥n
            if (!ubicacionActual || !geolocalizacionActivada) {
                mensajeTelepizzero.textContent = "‚ùå No se pudo obtener la ubicaci√≥n. Por favor, activa la geolocalizaci√≥n primero.";
                permisoGeolocalizacion.style.display = 'block';
                contenidoFichaje.style.display = 'none';
                return;
            }
            
            const dni = dniInput.value.trim();
            
            // Validar DNI (8 d√≠gitos exactos)
            if (!dni || dni.length !== 8 || !/^\d{8}$/.test(dni)) {
                mensajeTelepizzero.textContent = "‚ùå DNI inv√°lido. Debe tener exactamente 8 d√≠gitos num√©ricos.";
                dniInput.focus();
                return;
            }
            
            // Buscar telepizzero por DNI
            const telepizzero = telepizzeros.find(t => t.dni === dni);
            
            if (!telepizzero) {
                mensajeTelepizzero.textContent = "‚ùå DNI no registrado en el sistema.";
                dniInput.focus();
                return;
            }
            
            // Buscar si hay un registro activo (sin salida) para este DNI hoy
            const ahora = new Date();
            const fechaHoy = ahora.toISOString().split('T')[0];
            
            const registroActivo = registros.find(r => 
                r.dni === dni && 
                r.fecha === fechaHoy && 
                !r.salida
            );
            
            const horaActual = ahora.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            if (registroActivo) {
                // Registrar salida
                registroActivo.salida = horaActual;
                registroActivo.ubicacionSalida = { ...ubicacionActual };
                
                // Calcular horas trabajadas
                const entrada = new Date(`${fechaHoy} ${registroActivo.entrada}`);
                const salida = new Date(`${fechaHoy} ${horaActual}`);
                const diffMs = salida - entrada;
                const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                
                registroActivo.horasTrabajadas = `${diffHrs}h ${diffMins}m`;
                
                mensajeTelepizzero.textContent = `‚úÖ Salida registrada a las ${horaActual}. ¬°Buen trabajo ${telepizzero.nombre}!`;
                mensajeTelepizzero.style.borderLeftColor = '#4CAF50';
            } else {
                // Registrar entrada
                const nuevoRegistro = {
                    nombre: telepizzero.nombre,
                    dni: telepizzero.dni,
                    fecha: fechaHoy,
                    entrada: horaActual,
                    salida: null,
                    horasTrabajadas: null,
                    ubicacionEntrada: { ...ubicacionActual },
                    ubicacionSalida: null,
                    dispositivo: navigator.userAgent,
                    timestamp: ahora.toISOString()
                };
                
                registros.push(nuevoRegistro);
                mensajeTelepizzero.textContent = `‚úÖ Entrada registrada a las ${horaActual}. ¬°Bienvenido ${telepizzero.nombre}!`;
                mensajeTelepizzero.style.borderLeftColor = '#4CAF50';
            }
            
            // Guardar y sincronizar en la nube
            if (guardarYSincronizar()) {
                // Actualizar contador de registros
                totalRegistrosElement.textContent = registros.length;
                
                // Mostrar mensaje de sincronizaci√≥n
                setTimeout(() => {
                    const syncMsg = document.createElement('div');
                    syncMsg.textContent = '‚úÖ Datos sincronizados en la nube';
                    syncMsg.style.color = '#4CAF50';
                    syncMsg.style.marginTop = '10px';
                    syncMsg.style.fontSize = '0.9rem';
                    mensajeTelepizzero.appendChild(syncMsg);
                    
                    setTimeout(() => syncMsg.remove(), 3000);
                }, 500);
            }
            
            // Limpiar campo y mantener foco
            dniInput.value = "";
            dniInput.focus();
            
            // Auto-scroll al mensaje
            mensajeTelepizzero.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        // ============================================
        // FUNCIONES DE GESTI√ìN DE REGISTROS
        // ============================================
        
        function cargarRegistros() {
            tablaRegistros.innerHTML = "";
            
            if (registros.length === 0) {
                const fila = document.createElement('tr');
                const celda = document.createElement('td');
                celda.colSpan = 7;
                celda.textContent = "üì≠ No hay registros disponibles";
                celda.style.textAlign = "center";
                celda.style.padding = "40px";
                celda.style.color = "#FFC72C";
                fila.appendChild(celda);
                tablaRegistros.appendChild(fila);
                return;
            }
            
            // Ordenar registros por fecha (m√°s reciente primero) y por hora de entrada
            const registrosOrdenados = [...registros].sort((a, b) => {
                if (a.fecha === b.fecha) {
                    return a.entrada < b.entrada ? 1 : -1;
                }
                return a.fecha < b.fecha ? 1 : -1;
            });
            
            registrosOrdenados.forEach(registro => {
                const fila = document.createElement('tr');
                fila.className = 'fade-in';
                
                const celdaNombre = document.createElement('td');
                celdaNombre.textContent = registro.nombre;
                
                const celdaDNI = document.createElement('td');
                celdaDNI.textContent = registro.dni;
                
                const celdaFecha = document.createElement('td');
                celdaFecha.textContent = registro.fecha;
                
                const celdaEntrada = document.createElement('td');
                celdaEntrada.textContent = registro.entrada || "-";
                
                const celdaSalida = document.createElement('td');
                celdaSalida.textContent = registro.salida || "-";
                
                const celdaHoras = document.createElement('td');
                celdaHoras.textContent = registro.horasTrabajadas || "-";
                
                const celdaUbicacion = document.createElement('td');
                if (registro.ubicacionEntrada) {
                    const enlaceMapa = `https://maps.google.com/?q=${registro.ubicacionEntrada.latitud},${registro.ubicacionEntrada.longitud}`;
                    celdaUbicacion.innerHTML = `<a href="${enlaceMapa}" target="_blank" style="color: #FFC72C; text-decoration: none; font-weight: bold;">üìç Ver</a>`;
                } else {
                    celdaUbicacion.textContent = "-";
                }
                
                fila.appendChild(celdaNombre);
                fila.appendChild(celdaDNI);
                fila.appendChild(celdaFecha);
                fila.appendChild(celdaEntrada);
                fila.appendChild(celdaSalida);
                fila.appendChild(celdaHoras);
                fila.appendChild(celdaUbicacion);
                
                tablaRegistros.appendChild(fila);
            });
        }
        
        // ============================================
        // FUNCIONES DE GESTI√ìN DE USUARIOS
        // ============================================
        
        function agregarUsuario() {
            const dni = nuevoDni.value.trim();
            const nombre = nuevoNombre.value.trim().toUpperCase();
            
            // Validar DNI
            if (!dni || dni.length !== 8 || !/^\d{8}$/.test(dni)) {
                alert("‚ùå DNI inv√°lido. Debe tener exactamente 8 d√≠gitos num√©ricos.");
                nuevoDni.focus();
                return;
            }
            
            if (!nombre) {
                alert("‚ùå Por favor, introduce el nombre del telepizzero");
                nuevoNombre.focus();
                return;
            }
            
            // Verificar si el DNI ya existe
            if (telepizzeros.some(u => u.dni === dni)) {
                alert("‚ö†Ô∏è Ya existe un telepizzero con ese DNI");
                nuevoDni.focus();
                return;
            }
            
            // Agregar el nuevo usuario
            telepizzeros.push({ dni, nombre });
            
            // Guardar y sincronizar
            if (guardarYSincronizar()) {
                // Actualizar la interfaz
                cargarUsuarios();
                cargarSelectUsuarios();
                
                // Limpiar campos
                nuevoDni.value = "";
                nuevoNombre.value = "";
                
                // Mostrar mensaje de √©xito
                alert(`‚úÖ Telepizzero ${nombre} agregado correctamente`);
                
                // Enfocar el campo DNI para nuevo registro
                nuevoDni.focus();
            } else {
                alert("‚ùå Error al guardar el usuario. Int√©ntalo de nuevo.");
            }
        }
        
        function cargarUsuarios() {
            listaUsuarios.innerHTML = "";
            
            if (telepizzeros.length === 0) {
                listaUsuarios.innerHTML = "<p style='text-align: center; color: #FFC72C;'>üì≠ No hay telepizzeros registrados</p>";
                return;
            }
            
            // Ordenar usuarios por nombre
            const usuariosOrdenados = [...telepizzeros].sort((a, b) => a.nombre.localeCompare(b.nombre));
            
            usuariosOrdenados.forEach(usuario => {
                const usuarioItem = document.createElement('div');
                usuarioItem.className = 'usuario-item fade-in';
                
                // Contar registros de este usuario
                const totalRegistrosUsuario = registros.filter(r => r.dni === usuario.dni).length;
                
                usuarioItem.innerHTML = `
                    <div>
                        <strong>${usuario.nombre}</strong>
                        <div style="font-size: 0.9rem; color: #FFC72C;">DNI: ${usuario.dni}</div>
                        <div style="font-size: 0.8rem; color: #aaa;">Registros: ${totalRegistrosUsuario}</div>
                    </div>
                    <div class="botones-accion">
                        <button class="btn btn-danger btn-small btn-eliminar" data-dni="${usuario.dni}">üóëÔ∏è Eliminar</button>
                    </div>
                `;
                
                listaUsuarios.appendChild(usuarioItem);
            });
            
            // Agregar event listeners a los botones de eliminar
            document.querySelectorAll('.btn-eliminar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const dni = this.getAttribute('data-dni');
                    eliminarUsuario(dni);
                });
            });
        }
        
        function eliminarUsuario(dni) {
            if (confirm("‚ö†Ô∏è ¬øEst√°s seguro de que deseas eliminar este telepizzero?\n\nEsta acci√≥n tambi√©n eliminar√° todos sus registros de jornadas.")) {
                // Encontrar el nombre del usuario para el mensaje
                const usuario = telepizzeros.find(u => u.dni === dni);
                const nombreUsuario = usuario ? usuario.nombre : "Usuario";
                
                // Eliminar el usuario
                telepizzeros = telepizzeros.filter(u => u.dni !== dni);
                
                // Tambi√©n eliminar sus registros
                registros = registros.filter(r => r.dni !== dni);
                
                // Guardar cambios
                if (guardarYSincronizar()) {
                    // Actualizar la interfaz
                    cargarUsuarios();
                    cargarSelectUsuarios();
                    cargarRegistros();
                    
                    alert(`‚úÖ Telepizzero ${nombreUsuario} eliminado correctamente`);
                } else {
                    alert("‚ùå Error al eliminar el usuario. Int√©ntalo de nuevo.");
                }
            }
        }
        
        function cargarSelectUsuarios() {
            selectUsuarioAusencia.innerHTML = "";
            
            // Ordenar usuarios por nombre
            const usuariosOrdenados = [...telepizzeros].sort((a, b) => a.nombre.localeCompare(b.nombre));
            
            usuariosOrdenados.forEach(usuario => {
                const option = document.createElement('option');
                option.value = usuario.dni;
                option.textContent = `${usuario.nombre} (${usuario.dni})`;
                selectUsuarioAusencia.appendChild(option);
            });
        }
        
        // ============================================
        // FUNCIONES DE CONTROL DE AUSENCIAS
        // ============================================
        
        function registrarAusencia() {
            const dni = selectUsuarioAusencia.value;
            const fecha = fechaAusencia.value;
            const tipo = tipoAusencia.value;
            const motivo = motivoAusencia.value.trim();
            
            if (!dni || !fecha) {
                alert("‚ùå Por favor, completa todos los campos obligatorios");
                return;
            }
            
            // Buscar el usuario
            const usuario = telepizzeros.find(u => u.dni === dni);
            
            // Registrar la ausencia
            const ausencia = {
                dni,
                nombre: usuario.nombre,
                fecha,
                tipo,
                motivo: motivo || "No especificado",
                fechaRegistro: new Date().toLocaleString('es-ES'),
                registradoPor: "Gerencia"
            };
            
            ausencias.push(ausencia);
            
            // Guardar y sincronizar
            if (guardarYSincronizar()) {
                // Actualizar la interfaz
                cargarAusencias();
                
                // Limpiar campos
                motivoAusencia.value = "";
                
                // Mostrar mensaje de √©xito
                alert(`‚úÖ Incidencia registrada correctamente para ${usuario.nombre}`);
            } else {
                alert("‚ùå Error al registrar la incidencia. Int√©ntalo de nuevo.");
            }
        }
        
        function cargarAusencias() {
            listaAusencias.innerHTML = "";
            
            if (ausencias.length === 0) {
                listaAusencias.innerHTML = "<p style='text-align: center; color: #FFC72C;'>‚úÖ No hay incidencias registradas</p>";
                return;
            }
            
            // Ordenar por fecha (m√°s reciente primero)
            const ausenciasOrdenadas = [...ausencias].sort((a, b) => {
                return a.fecha < b.fecha ? 1 : -1;
            });
            
            ausenciasOrdenadas.forEach(ausencia => {
                const ausenciaItem = document.createElement('div');
                ausenciaItem.className = `ausencia-item fade-in ${ausencia.tipo === 'falta' ? 'ausencia-marcada' : ''}`;
                
                let tipoTexto = "";
                let icono = "";
                
                switch(ausencia.tipo) {
                    case 'falta':
                        tipoTexto = "Falta injustificada";
                        icono = "‚ùå";
                        break;
                    case 'ausencia_justificada':
                        tipoTexto = "Ausencia justificada";
                        icono = "‚ö†Ô∏è";
                        break;
                    case 'retraso':
                        tipoTexto = "Retraso";
                        icono = "‚è∞";
                        break;
                }
                
                ausenciaItem.innerHTML = `
                    <div>
                        <strong>${icono} ${ausencia.nombre}</strong> (${ausencia.dni})
                        <div>üìÖ Fecha: ${ausencia.fecha} - ${tipoTexto}</div>
                        <div>üìù Motivo: ${ausencia.motivo}</div>
                        <div><small>üïê Registrado: ${ausencia.fechaRegistro}</small></div>
                    </div>
                    <div class="botones-accion">
                        <button class="btn btn-danger btn-small btn-eliminar-ausencia" data-id="${ausencia.dni}-${ausencia.fecha}">üóëÔ∏è</button>
                    </div>
                `;
                
                listaAusencias.appendChild(ausenciaItem);
            });
            
            // Agregar event listeners a los botones de eliminar
            document.querySelectorAll('.btn-eliminar-ausencia').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    eliminarAusencia(id);
                });
            });
        }
        
        function eliminarAusencia(id) {
            if (confirm("‚ö†Ô∏è ¬øEst√°s seguro de que deseas eliminar esta incidencia?")) {
                const [dni, fecha] = id.split('-');
                
                ausencias = ausencias.filter(a => !(a.dni === dni && a.fecha === fecha));
                
                // Guardar cambios
                if (guardarYSincronizar()) {
                    // Actualizar la interfaz
                    cargarAusencias();
                    
                    alert("‚úÖ Incidencia eliminada correctamente");
                } else {
                    alert("‚ùå Error al eliminar la incidencia. Int√©ntalo de nuevo.");
                }
            }
        }
        
        // ============================================
        // FUNCIONES DE CONFIGURACI√ìN DE CORREO
        // ============================================
        
        function guardarCorreo() {
            const correo = correoElectronico.value.trim();
            
            if (!correo) {
                alert("‚ùå Por favor, introduce un correo electr√≥nico v√°lido");
                return;
            }
            
            // Validar formato de correo b√°sico
            const regexCorreo = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!regexCorreo.test(correo)) {
                alert("‚ùå Por favor, introduce un correo electr√≥nico v√°lido (ejemplo@telepizza.com)");
                correoElectronico.focus();
                return;
            }
            
            // Guardar el correo
            correoGerencia = correo;
            
            // Guardar y sincronizar
            if (guardarYSincronizar()) {
                // Actualizar la interfaz
                cargarCorreoGuardado();
                
                // Limpiar campo
                correoElectronico.value = "";
                
                mensajeCorreo.textContent = `‚úÖ Correo ${correo} guardado correctamente`;
                mensajeCorreo.style.borderLeftColor = '#4CAF50';
                
                // Ocultar mensaje despu√©s de 3 segundos
                setTimeout(() => {
                    mensajeCorreo.textContent = "";
                }, 3000);
            } else {
                mensajeCorreo.textContent = "‚ùå Error al guardar el correo. Int√©ntalo de nuevo.";
                mensajeCorreo.style.borderLeftColor = '#FF5252';
            }
        }
        
        function cargarCorreoGuardado() {
            if (correoGerencia) {
                infoCorreoGuardado.innerHTML = `
                    <h3>‚úÖ Correo Vinculado</h3>
                    <p><strong>üìß Correo:</strong> ${correoGerencia}</p>
                    <p>Los reportes se enviar√°n autom√°ticamente a esta direcci√≥n.</p>
                    <button class="btn btn-danger btn-small" id="btnEliminarCorreo">üóëÔ∏è Eliminar Correo</button>
                `;
                
                // Agregar event listener al bot√≥n de eliminar
                document.getElementById('btnEliminarCorreo').addEventListener('click', eliminarCorreo);
            } else {
                infoCorreoGuardado.innerHTML = `
                    <h3>üìß No hay correo vinculado</h3>
                    <p>Para recibir reportes autom√°ticos, vincule un correo electr√≥nico.</p>
                `;
            }
        }
        
        function eliminarCorreo() {
            if (confirm("‚ö†Ô∏è ¬øEst√°s seguro de que deseas eliminar el correo vinculado?")) {
                correoGerencia = null;
                
                // Guardar y sincronizar
                if (guardarYSincronizar()) {
                    cargarCorreoGuardado();
                    mensajeCorreo.textContent = "‚úÖ Correo eliminado correctamente";
                    mensajeCorreo.style.borderLeftColor = '#4CAF50';
                    
                    // Ocultar mensaje despu√©s de 3 segundos
                    setTimeout(() => {
                        mensajeCorreo.textContent = "";
                    }, 3000);
                } else {
                    mensajeCorreo.textContent = "‚ùå Error al eliminar el correo. Int√©ntalo de nuevo.";
                    mensajeCorreo.style.borderLeftColor = '#FF5252';
                }
            }
        }
        
        // ============================================
        // FUNCIONES DE ENV√çO DE REPORTES
        // ============================================
        
        function enviarReporte(tipo) {
            if (!correoGerencia) {
                alert("‚ùå No hay un correo vinculado.\n\nPor favor, vincule un correo en la pesta√±a 'Configuraci√≥n de Correo'.");
                return;
            }
            
            // Mostrar mensaje de env√≠o
            mensajeCorreo.textContent = `‚è≥ Generando y enviando reporte ${tipo === 'diario' ? 'diario' : 'mensual'}...`;
            mensajeCorreo.style.borderLeftColor = '#FFC72C';
            
            // Simular env√≠o de correo (en un entorno real, aqu√≠ se har√≠a una petici√≥n a un servidor)
            setTimeout(() => {
                const hoy = new Date();
                let reporte = generarReporte(tipo);
                
                // Aqu√≠ normalmente se enviar√≠a el correo a trav√©s de un servidor
                // Para este ejemplo, solo mostramos un mensaje de simulaci√≥n
                mensajeCorreo.textContent = `‚úÖ Reporte ${tipo === 'diario' ? 'diario' : 'mensual'} enviado a ${correoGerencia}`;
                mensajeCorreo.style.borderLeftColor = '#4CAF50';
                
                // Mostrar detalles del reporte en consola (simulaci√≥n)
                console.log(`=== REPORTE ${tipo.toUpperCase()} ENVIADO A ${correoGerencia} ===`);
                console.log(reporte);
                
                // Ocultar mensaje despu√©s de 5 segundos
                setTimeout(() => {
                    mensajeCorreo.textContent = "";
                }, 5000);
            }, 2000);
        }
        
        function generarReporte(tipo) {
            const hoy = new Date();
            const fechaHoy = hoy.toISOString().split('T')[0];
            const mesActual = hoy.getMonth() + 1;
            const a√±oActual = hoy.getFullYear();
            
            let reporte = {
                tipo: tipo === 'diario' ? 'Reporte Diario' : 'Reporte Mensual',
                fechaGeneracion: hoy.toLocaleString('es-ES'),
                fechaPeriodo: tipo === 'diario' ? fechaHoy : `${mesActual}/${a√±oActual}`,
                totalTelepizzeros: telepizzeros.length,
                totalRegistros: 0,
                totalHorasTrabajadas: 0,
                totalAusencias: 0,
                detalles: []
            };
            
            if (tipo === 'diario') {
                // Reporte diario
                const registrosHoy = registros.filter(r => r.fecha === fechaHoy);
                const ausenciasHoy = ausencias.filter(a => a.fecha === fechaHoy);
                
                reporte.totalRegistros = registrosHoy.length;
                reporte.totalAusencias = ausenciasHoy.length;
                
                // Calcular horas trabajadas hoy
                let horasTotales = 0;
                registrosHoy.forEach(reg => {
                    if (reg.horasTrabajadas) {
                        const horasMatch = reg.horasTrabajadas.match(/(\d+)h (\d+)m/);
                        if (horasMatch) {
                            horasTotales += parseInt(horasMatch[1]) + (parseInt(horasMatch[2]) / 60);
                        }
                    }
                });
                reporte.totalHorasTrabajadas = horasTotales.toFixed(2);
                
                // Detalles
                reporte.detalles = {
                    registros: registrosHoy,
                    ausencias: ausenciasHoy,
                    telepizzerosPresentes: [...new Set(registrosHoy.map(r => r.nombre))],
                    telepizzerosAusentes: [...new Set(ausenciasHoy.map(a => a.nombre))]
                };
                
            } else {
                // Reporte mensual
                const registrosMes = registros.filter(r => {
                    const fechaReg = new Date(r.fecha);
                    return fechaReg.getMonth() + 1 === mesActual && fechaReg.getFullYear() === a√±oActual;
                });
                
                const ausenciasMes = ausencias.filter(a => {
                    const fechaAus = new Date(a.fecha);
                    return fechaAus.getMonth() + 1 === mesActual && fechaAus.getFullYear() === a√±oActual;
                });
                
                reporte.totalRegistros = registrosMes.length;
                reporte.totalAusencias = ausenciasMes.length;
                
                // Calcular horas trabajadas este mes
                let horasTotales = 0;
                registrosMes.forEach(reg => {
                    if (reg.horasTrabajadas) {
                        const horasMatch = reg.horasTrabajadas.match(/(\d+)h (\d+)m/);
                        if (horasMatch) {
                            horasTotales += parseInt(horasMatch[1]) + (parseInt(horasMatch[2]) / 60);
                        }
                    }
                });
                reporte.totalHorasTrabajadas = horasTotales.toFixed(2);
                
                // Resumen por telepizzero
                const resumenPorTelepizzero = {};
                telepizzeros.forEach(t => {
                    const registrosTelepizzero = registrosMes.filter(r => r.dni === t.dni);
                    const ausenciasTelepizzero = ausenciasMes.filter(a => a.dni === t.dni);
                    
                    let horasTrabajadas = 0;
                    registrosTelepizzero.forEach(reg => {
                        if (reg.horasTrabajadas) {
                            const horasMatch = reg.horasTrabajadas.match(/(\d+)h (\d+)m/);
                            if (horasMatch) {
                                horasTrabajadas += parseInt(horasMatch[1]) + (parseInt(horasMatch[2]) / 60);
                            }
                        }
                    });
                    
                    resumenPorTelepizzero[t.dni] = {
                        nombre: t.nombre,
                        dni: t.dni,
                        diasTrabajados: registrosTelepizzero.length,
                        ausencias: ausenciasTelepizzero.length,
                        horasTrabajadas: horasTrabajadas.toFixed(2)
                    };
                });
                
                reporte.detalles = {
                    resumenPorTelepizzero: resumenPorTelepizzero,
                    registros: registrosMes,
                    ausencias: ausenciasMes
                };
            }
            
            return reporte;
        }
        
        // ============================================
        // FUNCIONALIDADES ADICIONALES
        // ============================================
        
        // Permitir fichar con Enter
        dniInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                fichar();
            }
        });
        
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                btnAcceder.click();
            }
        });
        
        nuevoDni.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                nuevoNombre.focus();
            }
        });
        
        nuevoNombre.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                btnAgregarUsuario.click();
            }
        });
        
        correoElectronico.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                btnGuardarCorreo.click();
            }
        });
        
        // Verificar si estamos en un dispositivo m√≥vil
        function esDispositivoMovil() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // Ajustar comportamiento seg√∫n el dispositivo
        if (!esDispositivoMovil()) {
            console.log("üíª Modo PC detectado - Ajustando configuraci√≥n de geolocalizaci√≥n");
        }
        
        // ============================================
        // INICIALIZAR LA APLICACI√ìN
        // ============================================
        
        init();
        
        // Forzar recarga de datos al cargar la p√°gina
        window.addEventListener('load', function() {
            sincronizarConLaNube();
            console.log("üîÑ Sistema de Telepizza cargado y sincronizado");
        });
    </script>
</body>
</html>
